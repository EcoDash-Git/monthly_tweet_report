---
title: >
  Twitter Monthly Analysis –
  `r format(params$month_start, '%Y‑%m‑01')` to
  `r format(lubridate::ceiling_date(params$month_start, 'month') - 1, '%Y‑%m‑%d')`
author: ""
date: "`r Sys.Date()`"

params:
  month_start: !r lubridate::floor_date(Sys.Date(), unit = "month")

output:
  html_document:
    toc: true
    toc_float: true
    number_sections: false
  pdf_document:
    latex_engine: xelatex
    toc: true
---



```{r, echo = FALSE,warning = FALSE,message = FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Libraries
library(tidyverse)
library(lubridate)
library(tidytext)
library(stringi)
library(knitr)
library(kableExtra)
library(forcats)
library(widyr)
library(ggraph)
library(igraph)
library(data.table)
library(sentimentr)
library(DBI)
library(RPostgres)

# Handy labels
month_start <- as.Date(params$month_start)
month_end   <- ceiling_date(month_start, "month") - days(1)
month_label <- format(month_start, "%B %Y")

```

```{r}
# --- Supabase connection (keep as-env in production) ------------------------
Sys.setenv(
  SUPABASE_HOST = "aws-0-us-east-2.pooler.supabase.com",
  SUPABASE_PORT = "6543",
  SUPABASE_DB   = "postgres",
  SUPABASE_USER = "postgres.kubvrwnqmsmhwcuscvje",
  SUPABASE_PWD  = "hfa-tgt8nkj1AVM9vqe"
)

con <- DBI::dbConnect(
  RPostgres::Postgres(),
  host     = Sys.getenv("SUPABASE_HOST"),
  port     = as.integer(Sys.getenv("SUPABASE_PORT")),
  dbname   = Sys.getenv("SUPABASE_DB"),
  user     = Sys.getenv("SUPABASE_USER"),
  password = Sys.getenv("SUPABASE_PWD"),
  sslmode  = "require"
)

twitter_raw2 <- DBI::dbReadTable(con, "twitter_raw")

# ── 1. map handle → canonical user‑id ───────────────────────────
main_ids <- tibble::tribble(
  ~username,            ~main_id,
  "weave_db",           "1206153294680403968",
  "OdyseeTeam",         "1280241715987660801",
  "ardriveapp",         "1293193263579635712",
  "redstone_defi",      "1294053547630362630",
  "everpay_io",         "1334504432973848577",
  "decentlandlabs",     "1352388512788656136",
  "KYVENetwork",        "136377177683878784",
  "onlyarweave",        "1393171138436534272",
  "ar_io_network",      "1468980765211955205",
  "Permaswap",          "1496714415231717380",
  "communitylabs",      "1548502833401516032",
  "usewander",          "1559946771115163651",
  "apus_network",       "1569621659468054528",
  "fwdresearch",        "1573616135651545088",
  "perma_dao",          "1595075970309857280",
  "Copus_io",           "1610731228130312194",
  "basejumpxyz",        "1612781645588742145",
  "AnyoneFDN",          "1626376419268784130",
  "arweaveindia",       "1670147900033343489",
  "useload",            "1734941279379759105",
  "protocolland",       "1737805485326401536",
  "aoTheComputer",      "1750584639385939968",
  "ArweaveOasis",       "1750723327315030016",
  "aox_xyz",            "1751903735318720512",
  "astrousd",           "1761104764899606528",
  "PerplexFi",          "1775862139980226560",
  "autonomous_af",      "1777500373378322432",
  "Liquid_Ops",         "1795772412396507136",
  "ar_aostore",         "1797632049202794496",
  "FusionFiPro",        "1865790600462921728",
  "vela_ventures",      "1869466343000444928",
  "beaconwallet",       "1879152602681585664",
  "VentoSwap",          "1889714966321893376",
  "permawebjournal",    "1901592191065300993",
  "Botega_AF",          "1902521779161292800",
  "samecwilliams",      "409642632",
  "TateBerenbaum",      "801518825690824707",
  "ArweaveEco",         "892752981736779776"
)


# tweets_raw is the data frame you showed
tweets_tagged <- twitter_raw2 %>%
  left_join(main_ids, by = "username") %>%
  mutate(
    # ensure POSIXct (UTC); adapt if your `date` is already POSIXct
    date      = ymd_hms(date, tz = "UTC", quiet = TRUE),
    is_rt_txt = str_detect(text, "^RT @"),
    post_type = case_when(
      is_rt_txt ~ "retweet",
      user_id == main_id & !is_rt_txt & str_detect(text, "https://t.co") ~ "quote",
      user_id == main_id ~ "original",
      TRUE ~ "other"
    )
  )
```



```{r}
# ── Pre‑process master data frame ───────────────────────────────────────────
Sys.setlocale("LC_TIME", "C")   # English weekday names on any platform

df <- tweets_tagged %>% 
  mutate(
    day     = as.Date(date, tz = "UTC"),
    month   = lubridate::month(date),
    year    = lubridate::year(date),
    hour    = lubridate::hour(date),
    weekday = lubridate::wday(date, label = TRUE, abbr = FALSE, week_start = 1)
  ) %>% 
  filter(post_type != "other")

# ── Restrict to the current calendar month ─────────────────────────────────
df_month <- df %>% 
  filter(date >= month_start,
         date <  lubridate::ceiling_date(month_start, "month")) %>% 
  mutate(
    month_day  = lubridate::wday(date, label = TRUE, abbr = FALSE, week_start = 1),
    month_hour = lubridate::hour(date)
  )

if (nrow(df_month) == 0) {
  cat("\n\n### No tweets in", month_label, "– nothing to report.\n\n")
  knitr::knit_exit()
}

```




# Sentiment Analysis

```{r}
df_month1 <- df_month %>%
  as_tibble() %>%
  mutate(text = str_replace_all(text, "&quot;|&#x2F;", "'"),
         text = str_replace_all(text, "&#x2F;", "/"),
         text = str_replace_all(text, "<a(.*?)>", " "),
         text = str_replace_all(text, "&gt;|&lt;", " "),
         text = str_replace_all(text, "<[^>]*>", " "),
         text = str_replace_all(text, "http.*\\s*", " "),
         text = str_replace_all(text, "\\031", "'"),
         text = str_replace_all(text, "\\[|\\]|\\(|\\)|\\*|~|#|\\n|\\034|\\035|\\tI|_|\\\\", " "),
         text = str_replace_all(text, "\"|'", ""),
         text = str_replace_all(text, "a°|<|>|&amp;|\\024|\\033|U\\+0096", ""),
         words = str_count(text, "\\w+")) %>%
  filter(words > 5)


```



```{r}
polarity_dt   <- lexicon::hash_sentiment_jockers_rinker
sentiment_key <- polarity_dt %>%
  dplyr::filter(!x %in% c("damn","damned","dammit","goddamn","goddamned","hell","hells",
                          "heck","jail","spoiler","goblin","hot","shot","fuck","fucked",
                          "fucks","mindfuck"))
sentiment_key2 <- update_key(polarity_dt, x = data.frame(x = c("hot"), y = c(1)))

```


```{r}
mycomment  <- get_sentences(df_month1$text)
sentiments <- sentiment_by(mycomment, polarity_dt = sentiment_key2)

df_month1 <- df_month1 %>%
  mutate(element_id = seq_len(nrow(df_month1))) %>%
  inner_join(sentiments, by = "element_id")


```


```{r}

# Boxplot of sentiment
df_month1 %>%
  ggplot(aes(x = "", y = ave_sentiment)) +
  geom_boxplot(width = 0.3, outlier.color = "red") +
  labs(title = "Distribution of Average Sentiment Scores",
       y = "Average Sentiment", x = NULL) +
  theme_minimal() + coord_flip()

```


```{r}
# Sentiment class
df_month1 <- df_month1 %>%
  mutate(sentiment = case_when(
    ave_sentiment >  0.05 ~ "positive",
    ave_sentiment < -0.05 ~ "negative",
    TRUE ~ "neutral"
  ))

daily_sentiment <- df_month1 %>%
  group_by(day, sentiment) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(day) %>%
  mutate(percent = count / sum(count) * 100)

ggplot(daily_sentiment, aes(x = day, y = percent, color = sentiment)) +
  geom_line() +
  labs(title = "Daily Sentiment Trend on Twitter",
       x = "Date", y = "Percentage of Tweets", color = "Sentiment") +
  scale_color_manual(values = c("negative" = "red", "neutral" = "gray", "positive" = "blue")) +
  theme_minimal(base_size = 14)

```


```{r}
overall_sentiment <- df_month1 %>%
  count(sentiment) %>%
  mutate(percent = n / sum(n) * 100)

ggplot(overall_sentiment, aes(x = sentiment, y = percent, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c("negative" = "tomato", "neutral" = "khaki", "positive" = "skyblue")) +
  labs(title = "Overall Sentiment Distribution on Twitter",
       x = "Sentiment Type", y = "Percentage of Tweets") +
  theme_minimal(base_size = 14)


```

```{r}
sentiment_by_type <- df_month1 %>%
  count(post_type, sentiment) %>%
  group_by(post_type) %>%
  mutate(percent = n / sum(n) * 100) %>%
  ungroup()

ggplot(sentiment_by_type, aes(x = sentiment, y = percent, fill = sentiment)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ post_type) +
  scale_fill_manual(values = c("negative" = "tomato", "neutral" = "khaki", "positive" = "skyblue")) +
  labs(title = "Sentiment Distribution by Tweet Type",
       x = "Sentiment Type", y = "Percentage of Tweets") +
  theme_minimal(base_size = 14)



```





```{r}
daily_avg_sentiment <- df_month1 %>%
  group_by(day) %>%
  summarise(avg_sentiment = mean(ave_sentiment, na.rm = TRUE), .groups = "drop")

ggplot(daily_avg_sentiment, aes(x = day, y = avg_sentiment)) +
  geom_line() +
  labs(title = "Average Sentiment Score by Day",
       x = "Date", y = "Average Sentiment") +
  theme_minimal(base_size = 14)

```


```{r}
daily_sentiment_by_type <- df_month1 %>%
  group_by(day, post_type) %>%
  summarise(avg_sentiment = mean(ave_sentiment, na.rm = TRUE), .groups = "drop")

ggplot(daily_sentiment_by_type, aes(x = day, y = avg_sentiment, color = post_type)) +
  geom_line() +
  labs(title = "Average Sentiment Score by Day and Post Type",
       x = "Date", y = "Average Sentiment Score", color = "Post Type") +
  theme_minimal(base_size = 14) + theme(legend.position = "top")


```



```{r}
nrc_key <- lexicon::hash_nrc_emotions %>%
  dplyr::filter(emotion %in% c('trust',"anger","anticipation","fear","sadness","surprise","disgust","joy")) %>%
  dplyr::filter(!token %in% c("damn","damned","dammit","goddamn","goddamned","peach","curse","cursed","hell","hells","heck","fuck","fucked","fucks","mindfuck","punch","money","insane","crazy","shit")) %>%
  dplyr::filter(!(emotion %in% c("fear","sadness") & token == "cringe"))

```


```{r}
emotions2 <- emotion_by(df_month1$text, emotion_dt = nrc_key)
df_month2 <- inner_join(df_month1, emotions2, by = "element_id")


```


```{r}
y <- df_month2 %>%
  pivot_wider(names_from = emotion_type, values_from = ave_emotion) %>%
  mutate(across(c(anger:trust_negated), ~ ifelse(is.na(.x), 0, .x))) %>%
  mutate(
    anger       = anger - anger_negated,
    anticipation= anticipation - anticipation_negated,
    disgust     = disgust - disgust_negated,
    fear        = fear - fear_negated,
    joy         = joy - joy_negated,
    sadness     = sadness - sadness_negated,
    surprise    = surprise - surprise_negated,
    trust       = trust - trust_negated
  ) %>%
  pivot_longer(cols = anger:trust_negated, names_to = "emotion_type", values_to = "ave_emotion")

ggplot(y, aes(x = (ave_sentiment), y = log(engagement_rate))) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE, linetype = "dashed") +
  labs(title = "Relationship between Sentiment Polarity and Engagement Rate",
       x = "Average Sentiment Polarity", y = "Log Engagement Rate") +
  theme_minimal(base_size = 14)

```


## Emotion Analysis

```{r}

y_filtered <- y %>%
  filter(!str_detect(emotion_type, "negated$")) %>%
  filter(ave_emotion > 0)

daily_emotion <- y_filtered %>%
  group_by(day, emotion_type) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(day) %>%
  mutate(percent = count / sum(count) * 100)

ggplot(daily_emotion, aes(x = day, y = percent, color = emotion_type)) +
  geom_line(size = 0.5) +
  labs(title = "Daily Emotion Trend",
       x = "Date", y = "Percentage of Tweets", color = "Emotion") +
  theme_minimal(base_size = 14)


```





```{r}
overall_emotion <- y_filtered %>%
  count(emotion_type) %>%
  mutate(percent = n / sum(n) * 100)

ggplot(overall_emotion, aes(x = reorder(emotion_type, percent), y = percent, fill = emotion_type)) +
  geom_col(show.legend = FALSE) + coord_flip() +
  labs(title = "Overall Emotion Distribution",
       x = "Emotion", y = "Percentage of Tweets") +
  theme_minimal(base_size = 14)


```


```{r}
emotion_by_post_type <- y_filtered %>%
  count(post_type, emotion_type) %>%
  group_by(post_type) %>%
  mutate(percent = n / sum(n) * 100) %>%
  ungroup()

ggplot(emotion_by_post_type, aes(x = emotion_type, y = percent, fill = emotion_type)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ post_type) +
  labs(title = "Emotion Distribution by Tweet Type",
       x = "Emotion", y = "Percentage of Tweets") +
  theme_minimal(base_size = 14) + coord_flip()


```


